<!-- app/templates/dev_simchat.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador WhatsApp (DEV)</title>
  <style>
    :root{
      --green:#075E54;
      --bg:#ECE5DD;
      --in:#FFFFFF;
      --out:#DCF8C6;
      --muted:#667781;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif}
    .topbar{background:var(--green);color:#fff;padding:10px 12px;display:flex;gap:12px;align-items:center}
    .topbar h1{font-size:16px;margin:0 10px 0 0;font-weight:700}
    .topbar input{height:32px;border-radius:6px;border:0;padding:0 10px;min-width:280px;outline:none}
    .btn{height:32px;border-radius:8px;border:0;padding:0 12px;font-weight:600;cursor:pointer}
    .btn.gray{background:#e7edf3}
    .btn.green{background:#08c19d;color:#fff}
    .btn.red{background:#ef4444;color:#fff}
    .hint{background:#0f5132;color:#d1e7dd;padding:6px 12px;font-size:12px}
    .wrap{height:calc(100vh - 110px);display:flex;flex-direction:column}
    .chat{flex:1;overflow:auto;padding:18px 24px}
    .row{display:flex;margin:10px 0;width:100%}
    .row.in{justify-content:flex-start}
    .row.out{justify-content:flex-end}
    .bubble{
      max-width:min(76%,820px);
      padding:10px 36px 18px 12px;       /* espaço p/ timestamp dentro */
      border-radius:10px;
      position:relative;
      line-height:1.35;
      white-space:pre-wrap;word-wrap:break-word
    }
    .in .bubble{background:var(--in)}
    .out .bubble{background:var(--out)}
    .ts{position:absolute;right:8px;bottom:6px;color:var(--muted);font-size:11px}
    .footer{display:flex;gap:10px;align-items:center;padding:10px;background:#f3f3f3;border-top:1px solid #e7e7e7}
    #msg{flex:1;height:44px;border-radius:22px;border:2px solid #cfd4d9;padding:0 16px;outline:none;background:#fff}
    .btn.round{height:44px;border-radius:22px;padding:0 16px}
    .status-pill{
      background:#ffffff22;border:1px solid #ffffff55;color:#fff;border-radius:999px;
      padding:4px 10px;font-size:12px
    }
    .status-pill.off{background:#00000020;border-color:#00000026}
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Simulador WhatsApp (DEV)</h1>
    <input id="pnid" placeholder="Phone Number ID (tenant)" value="222222222222222" />
    <input id="phone" placeholder="WhatsApp do usuário" value="5561999999999" />
    <button id="btnConnect" class="btn gray">Conectar</button>
    <button id="btnHistory" class="btn gray">Carregar histórico</button>
    <button id="btnClear" class="btn gray">Limpar chat</button>
    <span id="pill" class="status-pill off">Desconectado</span>
  </div>

  <div class="hint">
    Tudo que o <strong>webhook</strong> receber (inbound/status) e tudo que for <strong>enviado</strong> (outbound) aparece aqui em tempo real. O delay entre mensagens é respeitado visualmente.
  </div>

  <div class="wrap">
    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="footer">
      <input id="msg" placeholder="Digite a mensagem…" />
      <button id="btnSend" class="btn round green">Enviar</button>
      <button id="btnSimulate" class="btn round green" title="Trocar para modo simulado (sem webhook)">Simular (sem webhook)</button>
    </div>
  </div>

  <script>
    // ---------------- State ----------------
    let es = null;                 // EventSource
    let isConnected = false;
    const seenIds = new Set();     // dedupe por ID do banco
    const chat = document.getElementById('chat');
    const pnidEl = document.getElementById('pnid');
    const phoneEl = document.getElementById('phone');
    const msgEl = document.getElementById('msg');
    const pill = document.getElementById('pill');
    const btnConnect = document.getElementById('btnConnect');

    function fmtTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      } catch { return ''; }
    }
    function scrollBottom(){ chat.scrollTop = chat.scrollHeight; }

    function bubble(dir, text, ts) {
      const row = document.createElement('div'); row.className='row '+dir;
      const b = document.createElement('div'); b.className='bubble';
      b.textContent = text || '';
      const t = document.createElement('div'); t.className='ts'; t.textContent = fmtTime(ts);
      b.appendChild(t); row.appendChild(b); chat.appendChild(row); scrollBottom();
    }

    function renderMessage(m){
      if (!m || !m.id) return;
      if (seenIds.has(m.id)) return;   // evita duplicatas
      seenIds.add(m.id);

      const dir = m.direction === 'inbound' ? 'in' : 'out';
      const text = m.text || (m.attachments_meta ? JSON.stringify(m.attachments_meta) : '(sem conteúdo)');
      bubble(dir, text, m.created_at);
    }

    // ---------------- Stream (SSE) ----------------
    function connect() {
      if (isConnected) return;
      const pnid = encodeURIComponent(pnidEl.value.trim());
      const phone = encodeURIComponent(phoneEl.value.trim());
      if (!pnid || !phone) { alert('Informe PNID e telefone.'); return; }

      // fecha anterior se houver
      if (es) { try { es.close(); } catch {} es = null; }

      es = new EventSource(`/dev/stream?pnid=${pnid}&phone=${phone}`);
      es.onopen = () => {
        isConnected = true;
        btnConnect.textContent = 'Desconectar';
        btnConnect.classList.remove('gray'); btnConnect.classList.add('red');
        pill.textContent = 'Conectado'; pill.classList.remove('off');
      };
      es.onerror = () => {
        disconnect(); // cai para estado desconectado
      };
      es.onmessage = (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          if (Array.isArray(payload)) {
            payload.forEach(renderMessage);
          }
        } catch { /* ignore */ }
      };
    }
    function disconnect() {
      if (es) try { es.close(); } catch {}
      es = null; isConnected = false;
      btnConnect.textContent = 'Conectar';
      btnConnect.classList.remove('red'); btnConnect.classList.add('gray');
      pill.textContent = 'Desconectado'; pill.classList.add('off');
    }
    btnConnect.addEventListener('click', () => isConnected ? disconnect() : connect());

    // ---------------- Histórico ----------------
    async function loadHistory() {
      const pnid = pnidEl.value.trim();
      const phone = phoneEl.value.trim();
      if (!pnid || !phone) { alert('Informe PNID e telefone.'); return; }

      // limpa antes de carregar — não carrega automaticamente na abertura
      chat.innerHTML = ''; seenIds.clear();

      const res = await fetch(`/dev/messages?pnid=${encodeURIComponent(pnid)}&phone=${encodeURIComponent(phone)}&limit=300`, {cache:'no-store'});
      const data = await res.json();
      const messages = (data.messages || []).sort((a,b)=> (a.created_at>b.created_at?1:-1));
      messages.forEach(renderMessage);
    }
    document.getElementById('btnHistory').addEventListener('click', loadHistory);

    // ---------------- Limpar ----------------
    document.getElementById('btnClear').addEventListener('click', () => {
      chat.innerHTML = ''; seenIds.clear(); msgEl.focus();
    });

    // ---------------- Enviar ----------------
    async function handleSend() {
      const text = msgEl.value.trim();
      if (!text) return;
      const pnid = pnidEl.value.trim();
      const phone = phoneEl.value.trim();
      if (!pnid || !phone) { alert('Informe PNID e telefone.'); return; }
      msgEl.value = '';

      if (isConnected) {
        // Webhook real: NÃO ecoa localmente; o SSE desenhará do banco
        const payload = {
          entry:[{changes:[{value:{
            messaging_product:'whatsapp',
            messages:[{from: phone, type:'text', text:{body:text}}],
            metadata:{phone_number_id: pnid}
          }}]}]
        };
        try {
          await fetch('/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        } catch (e) {
          alert('Falha ao enviar para o webhook: '+e);
        }
      } else {
        // Modo simulado: ecoa inbound e pede ações ao /dev/simulate
        bubble('in', text, new Date().toISOString());
        try {
          const res = await fetch('/dev/simulate', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({phone_number_id: pnid, from: phone, text})
          });
          const data = await res.json();
          const actions = data.actions || [];
          // Respeita delay por ação (a.delay) OU aplica 5s entre mensagens a partir da 2ª
          let acc = 0;
          actions.forEach((a, idx) => {
            const d = (Number(a.delay) || (idx>0?5:0)) * 1000;
            acc += d;
            setTimeout(()=>{
              if (a.text) bubble('out', a.text, new Date().toISOString());
              else if (a.template) bubble('out', JSON.stringify(a.template), new Date().toISOString());
            }, acc);
          });
        } catch (e) {
          alert('Falha ao simular: '+e);
        }
      }
    }
    document.getElementById('btnSend').addEventListener('click', handleSend);

    // ---------------- Modo simulado (apenas alterna o modo) ----------------
    document.getElementById('btnSimulate').addEventListener('click', () => {
      // apenas garante que está desconectado; envio é sempre pelo botão Enviar
      disconnect();
      msgEl.focus();
    });

    // UX: Enter envia; Shift+Enter quebra linha
    msgEl.addEventListener('keydown', (e)=>{
      if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
    });

    // ---------------- Iniciar já conectado ----------------
    window.addEventListener('load', () => {
      if (pnidEl.value.trim() && phoneEl.value.trim()) connect();
      msgEl.focus();
    });
  </script>
</body>
</html>
